1	/* eslint-disable @next/next/no-img-element */
2	
3	import { useRouter } from 'next/navigation';
4	import React, {
5	  useCallback,
6	  useEffect,
7	  useMemo,
8	  useRef,
9	  useState,
10	} from 'react';
11	
12	import type { DanmakuComment, DanmakuSelection } from '@/lib/danmaku/types';
13	import { SearchResult } from '@/lib/types';
14	import { getVideoResolutionFromM3u8, processImageUrl } from '@/lib/utils';
15	
16	import DanmakuPanel from '@/components/DanmakuPanel';
17	
18	// å®šä¹‰è§†é¢‘ä¿¡æ¯ç±»å‹
19	interface VideoInfo {
20	  quality: string;
21	  loadSpeed: string;
22	  pingTime: number;
23	  hasError?: boolean; // æ·»åŠ é”™è¯¯çŠ¶æ€æ ‡è¯?
24	}
25	
26	interface EpisodeSelectorProps {
27	  /** æ€»é›†æ•?*/
28	  totalEpisodes: number;
29	  /** æ¯é¡µæ˜¾ç¤ºå¤šå°‘é›†ï¼Œé»˜è®¤ 50 */
30	  episodesPerPage?: number;
31	  /** å½“å‰é€‰ä¸­çš„é›†æ•°ï¼ˆ1 å¼€å§‹ï¼‰ */
32	  value?: number;
33	  /** ç”¨æˆ·ç‚¹å‡»é€‰é›†åçš„å›è°ƒ */
34	  onChange?: (episodeNumber: number) => void;
35	  /** æ¢æºç›¸å…³ */
36	  onSourceChange?: (source: string, id: string, title: string) => void;
37	  currentSource?: string;
38	  currentId?: string;
39	  videoTitle?: string;
40	  videoYear?: string;
41	  availableSources?: SearchResult[];
42	  sourceSearchLoading?: boolean;
43	  sourceSearchError?: string | null;
44	  /** é¢„è®¡ç®—çš„æµ‹é€Ÿç»“æœï¼Œé¿å…é‡å¤æµ‹é€?*/
45	  precomputedVideoInfo?: Map<string, VideoInfo>;
46	  onDanmakuSelect?: (selection: DanmakuSelection) => void;
47	  currentDanmakuSelection?: DanmakuSelection | null;
48	  onUploadDanmaku?: (comments: DanmakuComment[]) => void;
49	}
50	
51	/**
52	 * é€‰é›†ç»„ä»¶ï¼Œæ”¯æŒåˆ†é¡µã€è‡ªåŠ¨æ»šåŠ¨èšç„¦å½“å‰åˆ†é¡µæ ‡ç­¾ï¼Œä»¥åŠæ¢æºåŠŸèƒ½ã€?
53	 */
54	const EpisodeSelector: React.FC<EpisodeSelectorProps> = ({
55	  totalEpisodes,
56	  episodesPerPage = 50,
57	  value = 1,
58	  onChange,
59	  onSourceChange,
60	  currentSource,
61	  currentId,
62	  videoTitle,
63	  availableSources = [],
64	  sourceSearchLoading = false,
65	  sourceSearchError = null,
66	  precomputedVideoInfo,
67	  onDanmakuSelect,
68	  currentDanmakuSelection,
69	  onUploadDanmaku,
70	}) => {
71	  const router = useRouter();
72	  const pageCount = Math.ceil(totalEpisodes / episodesPerPage);
73	
74	  // å­˜å‚¨æ¯ä¸ªæºçš„è§†é¢‘ä¿¡æ¯
75	  const [videoInfoMap, setVideoInfoMap] = useState<Map<string, VideoInfo>>(
76	    new Map()
77	  );
78	  const [attemptedSources, setAttemptedSources] = useState<Set<string>>(
79	    new Set()
80	  );
81	
82	  // ä½¿ç”¨ ref æ¥é¿å…é—­åŒ…é—®é¢?
83	  const attemptedSourcesRef = useRef<Set<string>>(new Set());
84	  const videoInfoMapRef = useRef<Map<string, VideoInfo>>(new Map());
85	
86	  // åŒæ­¥çŠ¶æ€åˆ° ref
87	  useEffect(() => {
88	    attemptedSourcesRef.current = attemptedSources;
89	  }, [attemptedSources]);
90	
91	  useEffect(() => {
92	    videoInfoMapRef.current = videoInfoMap;
93	  }, [videoInfoMap]);
94	
95	  // ä¸»è¦çš?tab çŠ¶æ€ï¼š'episodes' æˆ?'sources'
96	  // å½“åªæœ‰ä¸€é›†æ—¶é»˜è®¤å±•ç¤º "æ¢æº"ï¼Œå¹¶éšè— "é€‰é›†" æ ‡ç­¾
97	  const [activeTab, setActiveTab] = useState<'danmaku' | 'episodes' | 'sources'>(
98	    totalEpisodes > 1 ? 'episodes' : 'sources'
99	  );
100	
101	  // å½“å‰åˆ†é¡µç´¢å¼•ï¼? å¼€å§‹ï¼‰
102	  const initialPage = Math.floor((value - 1) / episodesPerPage);
103	  const [currentPage, setCurrentPage] = useState<number>(initialPage);
104	
105	  // æ˜¯å¦å€’åºæ˜¾ç¤º
106	  const [descending, setDescending] = useState<boolean>(false);
107	
108	  // æ ¹æ® descending çŠ¶æ€è®¡ç®—å®é™…æ˜¾ç¤ºçš„åˆ†é¡µç´¢å¼•
109	  const displayPage = useMemo(() => {
110	    if (descending) {
111	      return pageCount - 1 - currentPage;
112	    }
113	    return currentPage;
114	  }, [currentPage, descending, pageCount]);
115	
116	  // è·å–è§†é¢‘ä¿¡æ¯çš„å‡½æ•?- ç§»é™¤ attemptedSources ä¾èµ–é¿å…ä¸å¿…è¦çš„é‡æ–°åˆ›å»º
117	  const getVideoInfo = useCallback(async (source: SearchResult) => {
118	    const sourceKey = `${source.source}-${source.id}`;
119	
120	    // ä½¿ç”¨ ref è·å–æœ€æ–°çš„çŠ¶æ€ï¼Œé¿å…é—­åŒ…é—®é¢˜
121	    if (attemptedSourcesRef.current.has(sourceKey)) {
122	      return;
123	    }
124	
125	    // è·å–ç¬¬ä¸€é›†çš„URL
126	    if (!source.episodes || source.episodes.length === 0) {
127	      return;
128	    }
129	    const episodeUrl =
130	      source.episodes.length > 1 ? source.episodes[1] : source.episodes[0];
131	
132	    // æ ‡è®°ä¸ºå·²å°è¯•
133	    setAttemptedSources((prev) => new Set(prev).add(sourceKey));
134	
135	    try {
136	      const info = await getVideoResolutionFromM3u8(episodeUrl);
137	      setVideoInfoMap((prev) => new Map(prev).set(sourceKey, info));
138	    } catch (error) {
139	      // å¤±è´¥æ—¶ä¿å­˜é”™è¯¯çŠ¶æ€?
140	      setVideoInfoMap((prev) =>
141	        new Map(prev).set(sourceKey, {
142	          quality: '´íÎó',
143	          loadSpeed: 'Î´Öª',
144	          pingTime: 0,
145	          hasError: true,
146	        })
147	      );
148	    }
149	  }, []);
150	
151	  // å½“æœ‰é¢„è®¡ç®—ç»“æœæ—¶ï¼Œå…ˆåˆå¹¶åˆ°videoInfoMapä¸?
152	  useEffect(() => {
153	    if (precomputedVideoInfo && precomputedVideoInfo.size > 0) {
154	      // åŸå­æ€§åœ°æ›´æ–°ä¸¤ä¸ªçŠ¶æ€ï¼Œé¿å…æ—¶åºé—®é¢˜
155	      setVideoInfoMap((prev) => {
156	        const newMap = new Map(prev);
157	        precomputedVideoInfo.forEach((value, key) => {
158	          newMap.set(key, value);
159	        });
160	        return newMap;
161	      });
162	
163	      setAttemptedSources((prev) => {
164	        const newSet = new Set(prev);
165	        precomputedVideoInfo.forEach((info, key) => {
166	          if (!info.hasError) {
167	            newSet.add(key);
168	          }
169	        });
170	        return newSet;
171	      });
172	
173	      // åŒæ­¥æ›´æ–° refï¼Œç¡®ä¿?getVideoInfo èƒ½ç«‹å³çœ‹åˆ°æ›´æ–?
174	      precomputedVideoInfo.forEach((info, key) => {
175	        if (!info.hasError) {
176	          attemptedSourcesRef.current.add(key);
177	        }
178	      });
179	    }
180	  }, [precomputedVideoInfo]);
181	
182	  // è¯»å–æœ¬åœ°â€œä¼˜é€‰å’Œæµ‹é€Ÿâ€å¼€å…³ï¼Œé»˜è®¤å¼€å?
183	  const [optimizationEnabled] = useState<boolean>(() => {
184	    if (typeof window !== 'undefined') {
185	      const saved = localStorage.getItem('enableOptimization');
186	      if (saved !== null) {
187	        try {
188	          return JSON.parse(saved);
189	        } catch {
190	          /* ignore */
191	        }
192	      }
193	    }
194	    return true;
195	  });
196	
197	  // å½“åˆ‡æ¢åˆ°æ¢æºtabå¹¶ä¸”æœ‰æºæ•°æ®æ—¶ï¼Œå¼‚æ­¥è·å–è§†é¢‘ä¿¡æ¯ - ç§»é™¤ attemptedSources ä¾èµ–é¿å…å¾ªç¯è§¦å‘
198	  useEffect(() => {
199	    const fetchVideoInfosInBatches = async () => {
200	      if (
201	        !optimizationEnabled || // è‹¥å…³é—­æµ‹é€Ÿåˆ™ç›´æ¥é€€å‡?
202	        activeTab !== 'sources' ||
203	        availableSources.length === 0
204	      )
205	        return;
206	
207	      // ç­›é€‰å‡ºå°šæœªæµ‹é€Ÿçš„æ’­æ”¾æº?
208	      const pendingSources = availableSources.filter((source) => {
209	        const sourceKey = `${source.source}-${source.id}`;
210	        return !attemptedSourcesRef.current.has(sourceKey);
211	      });
212	
213	      if (pendingSources.length === 0) return;
214	
215	      const batchSize = Math.ceil(pendingSources.length / 2);
216	
217	      for (let start = 0; start < pendingSources.length; start += batchSize) {
218	        const batch = pendingSources.slice(start, start + batchSize);
219	        await Promise.all(batch.map(getVideoInfo));
220	      }
221	    };
222	
223	    fetchVideoInfosInBatches();
224	    // ä¾èµ–é¡¹ä¿æŒä¸ä¹‹å‰ä¸€è‡?
225	  }, [activeTab, availableSources, getVideoInfo, optimizationEnabled]);
226	
227	  // å‡åºåˆ†é¡µæ ‡ç­¾
228	  const categoriesAsc = useMemo(() => {
229	    return Array.from({ length: pageCount }, (_, i) => {
230	      const start = i * episodesPerPage + 1;
231	      const end = Math.min(start + episodesPerPage - 1, totalEpisodes);
232	      return { start, end };
233	    });
234	  }, [pageCount, episodesPerPage, totalEpisodes]);
235	
236	  // æ ¹æ® descending çŠ¶æ€å†³å®šåˆ†é¡µæ ‡ç­¾çš„æ’åºå’Œå†…å®?
237	  const categories = useMemo(() => {
238	    if (descending) {
239	      // å€’åºæ—¶ï¼Œlabel ä¹Ÿå€’åºæ˜¾ç¤º
240	      return [...categoriesAsc]
241	        .reverse()
242	        .map(({ start, end }) => `${end}-${start}`);
243	    }
244	    return categoriesAsc.map(({ start, end }) => `${start}-${end}`);
245	  }, [categoriesAsc, descending]);
246	
247	  const categoryContainerRef = useRef<HTMLDivElement>(null);
248	  const buttonRefs = useRef<(HTMLButtonElement | null)[]>([]);
249	
250	  // å½“åˆ†é¡µåˆ‡æ¢æ—¶ï¼Œå°†æ¿€æ´»çš„åˆ†é¡µæ ‡ç­¾æ»šåŠ¨åˆ°è§†å£ä¸­é—?
251	  useEffect(() => {
252	    const btn = buttonRefs.current[displayPage];
253	    const container = categoryContainerRef.current;
254	    if (btn && container) {
255	      // æ‰‹åŠ¨è®¡ç®—æ»šåŠ¨ä½ç½®ï¼Œåªæ»šåŠ¨åˆ†é¡µæ ‡ç­¾å®¹å™¨
256	      const containerRect = container.getBoundingClientRect();
257	      const btnRect = btn.getBoundingClientRect();
258	      const scrollLeft = container.scrollLeft;
259	
260	      // è®¡ç®—æŒ‰é’®ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
261	      const btnLeft = btnRect.left - containerRect.left + scrollLeft;
262	      const btnWidth = btnRect.width;
263	      const containerWidth = containerRect.width;
264	
265	      // è®¡ç®—ç›®æ ‡æ»šåŠ¨ä½ç½®ï¼Œä½¿æŒ‰é’®å±…ä¸­
266	      const targetScrollLeft = btnLeft - (containerWidth - btnWidth) / 2;
267	
268	      // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½?
269	      container.scrollTo({
270	        left: targetScrollLeft,
271	        behavior: 'smooth',
272	      });
273	    }
274	  }, [displayPage, pageCount]);
275	
276	  // å¤„ç†æ¢æºtabç‚¹å‡»ï¼Œåªåœ¨ç‚¹å‡»æ—¶æ‰æœç´?
277	  const handleSourceTabClick = () => {
278	    setActiveTab('sources');
279	  };
280	
281	  const handleCategoryClick = useCallback(
282	    (index: number) => {
283	      if (descending) {
284	        // åœ¨å€’åºæ—¶ï¼Œéœ€è¦å°†æ˜¾ç¤ºç´¢å¼•è½¬æ¢ä¸ºå®é™…ç´¢å¼?
285	        setCurrentPage(pageCount - 1 - index);
286	      } else {
287	        setCurrentPage(index);
288	      }
289	    },
290	    [descending, pageCount]
291	  );
292	
293	  const handleEpisodeClick = useCallback(
294	    (episodeNumber: number) => {
295	      onChange?.(episodeNumber);
296	    },
297	    [onChange]
298	  );
299	
300	  const handleSourceClick = useCallback(
301	    (source: SearchResult) => {
302	      onSourceChange?.(source.source, source.id, source.title);
303	    },
304	    [onSourceChange]
305	  );
306	
307	  const currentStart = currentPage * episodesPerPage + 1;
308	  const currentEnd = Math.min(
309	    currentStart + episodesPerPage - 1,
310	    totalEpisodes
311	  );
312	
313	  return (
314	    <div className='md:ml-2 px-4 py-0 h-full rounded-xl bg-white/58 dark:bg-slate-900/45 backdrop-blur-xl flex flex-col border border-white/45 dark:border-white/20 shadow-lg overflow-hidden'>
315	      {/* ä¸»è¦çš?Tab åˆ‡æ¢ - æ— ç¼èå…¥è®¾è®¡ */}
316	      <div className='flex mb-1 -mx-6 flex-shrink-0'>
317	        {totalEpisodes > 1 && (
318	          <div
319	            onClick={() => setActiveTab('episodes')}
320	            className={`flex-1 py-3 px-6 text-center cursor-pointer transition-all duration-200 font-medium
321	              ${
322	                activeTab === 'episodes'
323	                  ? 'text-blue-600 dark:text-blue-400'
324	                  : 'text-gray-700 hover:text-blue-600 bg-black/5 dark:bg-white/5 dark:text-gray-300 dark:hover:text-blue-400 hover:bg-black/3 dark:hover:bg-white/3'
325	              }
326	            `.trim()}
327	          >
328	            Ñ¡¼¯
329	          </div>
330	        )}
331	        <div
332	          onClick={handleSourceTabClick}
333	          className={`flex-1 py-3 px-6 text-center cursor-pointer transition-all duration-200 font-medium
334	            ${
335	              activeTab === 'sources'
336	                ? 'text-blue-600 dark:text-blue-400'
337	                : 'text-gray-700 hover:text-blue-600 bg-black/5 dark:bg-white/5 dark:text-gray-300 dark:hover:text-blue-400 hover:bg-black/3 dark:hover:bg-white/3'
338	            }
339	          `.trim()}
340	        >
341	          »»Ô´
342	        </div>
343	        {onDanmakuSelect && (
344	          <div
345	            onClick={() => setActiveTab('danmaku')}
346	            className={`flex-1 py-3 px-6 text-center cursor-pointer transition-all duration-200 font-medium
347	              ${
348	                activeTab === 'danmaku'
349	                  ? 'text-blue-600 dark:text-blue-400'
350	                  : 'text-gray-700 hover:text-blue-600 bg-black/5 dark:bg-white/5 dark:text-gray-300 dark:hover:text-blue-400 hover:bg-black/3 dark:hover:bg-white/3'
351	              }
352	            `.trim()}
353	          >
354	            µ¯Ä»
355	          </div>
356	        )}
357	      </div>
358	
359	      {activeTab === 'danmaku' && onDanmakuSelect && (
360	        <div className='mt-2 flex-1 min-h-0 overflow-hidden'>
361	          <DanmakuPanel
362	            videoTitle={videoTitle || ''}
363	            currentEpisodeIndex={value - 1}
364	            onDanmakuSelect={onDanmakuSelect}
365	            currentSelection={currentDanmakuSelection || null}
366	            onUploadDanmaku={onUploadDanmaku}
367	          />
368	        </div>
369	      )}
370	
371	      {/* é€‰é›† Tab å†…å®¹ */}
372	      {activeTab === 'episodes' && (
373	        <>
374	          {/* åˆ†ç±»æ ‡ç­¾ */}
375	          <div className='flex items-center gap-4 mb-4 border-b border-gray-300 dark:border-gray-700 -mx-6 px-6 flex-shrink-0'>
376	            <div className='flex-1 overflow-x-auto' ref={categoryContainerRef}>
377	              <div className='flex gap-2 min-w-max'>
378	                {categories.map((label, idx) => {
379	                  const isActive = idx === displayPage;
380	                  return (
381	                    <button
382	                      key={label}
383	                      ref={(el) => {
384	                        buttonRefs.current[idx] = el;
385	                      }}
386	                      onClick={() => handleCategoryClick(idx)}
387	                      className={`w-20 relative py-2 text-sm font-medium transition-colors whitespace-nowrap flex-shrink-0 text-center 
388	                        ${
389	                          isActive
390	                            ? 'text-blue-500 dark:text-blue-400'
391	                            : 'text-gray-700 hover:text-blue-600 dark:text-gray-300 dark:hover:text-blue-400'
392	                        }
393	                      `.trim()}
394	                    >
395	                      {label}
396	                      {isActive && (
397	                        <div className='absolute bottom-0 left-0 right-0 h-0.5 bg-blue-500 dark:bg-blue-400' />
398	                      )}
399	                    </button>
400	                  );
401	                })}
402	              </div>
403	            </div>
404	            {/* å‘ä¸Š/å‘ä¸‹æŒ‰é’® */}
405	            <button
406	              className='flex-shrink-0 w-8 h-8 rounded-md flex items-center justify-center text-gray-700 hover:text-blue-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:text-blue-400 dark:hover:bg-white/20 transition-colors transform translate-y-[-4px]'
407	              onClick={() => {
408	                // åˆ‡æ¢é›†æ•°æ’åºï¼ˆæ­£åº?å€’åºï¼?
409	                setDescending((prev) => !prev);
410	              }}
411	            >
412	              <svg
413	                className='w-4 h-4'
414	                fill='none'
415	                stroke='currentColor'
416	                viewBox='0 0 24 24'
417	              >
418	                <path
419	                  strokeLinecap='round'
420	                  strokeLinejoin='round'
421	                  strokeWidth='2'
422	                  d='M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4'
423	                />
424	              </svg>
425	            </button>
426	          </div>
427	
428	          {/* é›†æ•°ç½‘æ ¼ */}
429	          <div className='grid grid-cols-[repeat(auto-fill,minmax(40px,1fr))] auto-rows-[40px] gap-x-3 gap-y-3 overflow-y-auto h-full pb-4'>
430	            {(() => {
431	              const len = currentEnd - currentStart + 1;
432	              const episodes = Array.from({ length: len }, (_, i) =>
433	                descending ? currentEnd - i : currentStart + i
434	              );
435	              return episodes;
436	            })().map((episodeNumber) => {
437	              const isActive = episodeNumber === value;
438	              return (
439	                <button
440	                  key={episodeNumber}
441	                  onClick={() => handleEpisodeClick(episodeNumber - 1)}
442	                  className={`h-10 flex items-center justify-center text-sm font-medium rounded-md transition-all duration-200 
443	                    ${
444	                      isActive
445	                        ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/25 dark:bg-blue-600'
446	                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300 hover:scale-105 dark:bg-white/10 dark:text-gray-300 dark:hover:bg-white/20'
447	                    }`.trim()}
448	                >
449	                  {episodeNumber}
450	                </button>
451	              );
452	            })}
453	          </div>
454	        </>
455	      )}
456	
457	      {/* æ¢æº Tab å†…å®¹ */}
458	      {activeTab === 'sources' && (
459	        <div className='flex flex-col h-full mt-4'>
460	          {sourceSearchLoading && (
461	            <div className='flex items-center justify-center py-8'>
462	              <div className='animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500'></div>
463	              <span className='ml-2 text-sm text-gray-600 dark:text-gray-300'>
464	                ËÑË÷ÖĞ...
465	              </span>
466	            </div>
467	          )}
468	
469	          {sourceSearchError && (
470	            <div className='flex items-center justify-center py-8'>
471	              <div className='text-center'>
472	                <div className='text-red-500 text-2xl mb-2'>??</div>
473	                <p className='text-sm text-red-600 dark:text-red-400'>
474	                  {sourceSearchError}
475	                </p>
476	              </div>
477	            </div>
478	          )}
479	
480	          {!sourceSearchLoading &&
481	            !sourceSearchError &&
482	            availableSources.length === 0 && (
483	              <div className='flex items-center justify-center py-8'>
484	                <div className='text-center'>
485	                  <div className='text-gray-400 text-2xl mb-2'>??</div>
486	                  <p className='text-sm text-gray-600 dark:text-gray-300'>
487	                    ÔİÎŞ¿ÉÓÃµÄ»»Ô´
488	                  </p>
489	                </div>
490	              </div>
491	            )}
492	
493	          {!sourceSearchLoading &&
494	            !sourceSearchError &&
495	            availableSources.length > 0 && (
496	              <div className='flex-1 overflow-y-auto space-y-2 pb-20'>
497	                {availableSources
498	                  .sort((a, b) => {
499	                    const aIsCurrent =
500	                      a.source?.toString() === currentSource?.toString() &&
501	                      a.id?.toString() === currentId?.toString();
502	                    const bIsCurrent =
503	                      b.source?.toString() === currentSource?.toString() &&
504	                      b.id?.toString() === currentId?.toString();
505	                    if (aIsCurrent && !bIsCurrent) return -1;
506	                    if (!aIsCurrent && bIsCurrent) return 1;
507	                    return 0;
508	                  })
509	                  .map((source, index) => {
510	                    const isCurrentSource =
511	                      source.source?.toString() === currentSource?.toString() &&
512	                      source.id?.toString() === currentId?.toString();
513	                    return (
514	                      <div
515	                        key={`${source.source}-${source.id}`}
516	                        onClick={() =>
517	                          !isCurrentSource && handleSourceClick(source)
518	                        }
519	                        className={`flex items-start gap-3 px-2 py-3 rounded-lg transition-all select-none duration-200 relative
520	                      ${
521	                        isCurrentSource
522	                          ? 'bg-blue-500/10 dark:bg-blue-500/20 border-blue-500/30 border'
523	                          : 'hover:bg-gray-200/50 dark:hover:bg-white/10 hover:scale-[1.02] cursor-pointer'
524	                      }`.trim()}
525	                      >
526	                        {/* å°é¢ */}
527	                        <div className='flex-shrink-0 w-12 h-20 bg-gray-300 dark:bg-gray-600 rounded overflow-hidden'>
528	                          {source.episodes && source.episodes.length > 0 && (
529	                            <img
530	                              src={processImageUrl(source.poster)}
531	                              alt={source.title}
532	                              className='w-full h-full object-cover'
533	                              onError={(e) => {
534	                                const target = e.target as HTMLImageElement;
535	                                target.style.display = 'none';
536	                              }}
537	                            />
538	                          )}
539	                        </div>
540	
541	                        {/* ä¿¡æ¯åŒºåŸŸ */}
542	                        <div className='flex-1 min-w-0 flex flex-col justify-between h-20'>
543	                          {/* æ ‡é¢˜å’Œåˆ†è¾¨ç‡ - é¡¶éƒ¨ */}
544	                          <div className='flex items-start justify-between gap-3 h-6'>
545	                            <div className='flex-1 min-w-0 relative group/title'>
546	                              <h3 className='font-medium text-base truncate text-gray-900 dark:text-gray-100 leading-none'>
547	                                {source.title}
548	                              </h3>
549	                              {/* æ ‡é¢˜çº§åˆ«çš?tooltip - ç¬¬ä¸€ä¸ªå…ƒç´ ä¸æ˜¾ç¤º */}
550	                              {index !== 0 && (
551	                                <div className='absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 invisible group-hover/title:opacity-100 group-hover/title:visible transition-all duration-200 ease-out delay-100 whitespace-nowrap z-[500] pointer-events-none'>
552	                                  {source.title}
553	                                  <div className='absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800'></div>
554	                                </div>
555	                              )}
556	                            </div>
557	                            {(() => {
558	                              const sourceKey = `${source.source}-${source.id}`;
559	                              const videoInfo = videoInfoMap.get(sourceKey);
560	
561	                              if (videoInfo && videoInfo.quality !== 'Î´Öª') {
562	                                if (videoInfo.hasError) {
563	                                  return (
564	                                    <div className='bg-gray-500/10 dark:bg-gray-400/20 text-red-600 dark:text-red-400 px-1.5 py-0 rounded text-xs flex-shrink-0 min-w-[50px] text-center'>
565	                                      ¼ì²âÊ§°Ü
566	                                    </div>
567	                                  );
568	                                } else {
569	                                  // æ ¹æ®åˆ†è¾¨ç‡è®¾ç½®ä¸åŒé¢œè‰²ï¼š2Kã€?Kä¸ºç´«è‰²ï¼Œ1080pã€?20pä¸ºç»¿è‰²ï¼Œå…¶ä»–ä¸ºé»„è‰?
570	                                  const isUltraHigh = ['4K', '2K'].includes(
571	                                    videoInfo.quality
572	                                  );
573	                                  const isHigh = ['1080p', '720p'].includes(
574	                                    videoInfo.quality
575	                                  );
576	                                  const textColorClasses = isUltraHigh
577	                                    ? 'text-purple-600 dark:text-purple-400'
578	                                    : isHigh
579	                                    ? 'text-blue-600 dark:text-blue-400'
580	                                    : 'text-yellow-600 dark:text-yellow-400';
581	
582	                                  return (
583	                                    <div
584	                                      className={`bg-gray-500/10 dark:bg-gray-400/20 ${textColorClasses} px-1.5 py-0 rounded text-xs flex-shrink-0 min-w-[50px] text-center`}
585	                                    >
586	                                      {videoInfo.quality}
587	                                    </div>
588	                                  );
589	                                }
590	                              }
591	
592	                              return null;
593	                            })()}
594	                          </div>
595	
596	                          {/* æºåç§°å’Œé›†æ•°ä¿¡æ¯ - å‚ç›´å±…ä¸­ */}
597	                          <div className='flex items-center justify-between'>
598	                            <span className='text-xs px-2 py-1 border border-gray-500/60 rounded text-gray-700 dark:text-gray-300'>
599	                              {source.source_name}
600	                            </span>
601	                            {source.episodes.length > 1 && (
602	                              <span className='text-xs text-gray-500 dark:text-gray-400 font-medium'>
603	                                {source.episodes.length} ¼¯
604	                              </span>
605	                            )}
606	                          </div>
607	
608	                          {/* ç½‘ç»œä¿¡æ¯ - åº•éƒ¨ */}
609	                          <div className='flex items-end h-6'>
610	                            {(() => {
611	                              const sourceKey = `${source.source}-${source.id}`;
612	                              const videoInfo = videoInfoMap.get(sourceKey);
613	                              if (videoInfo) {
614	                                if (!videoInfo.hasError) {
615	                                  return (
616	                                    <div className='flex items-end gap-3 text-xs'>
617	                                      <div className='text-blue-600 dark:text-blue-400 font-medium text-xs'>
618	                                        {videoInfo.loadSpeed}
619	                                      </div>
620	                                      <div className='text-orange-600 dark:text-orange-400 font-medium text-xs'>
621	                                        {videoInfo.pingTime}ms
622	                                      </div>
623	                                    </div>
624	                                  );
625	                                } else {
626	                                  return (
627	                                    <div className='text-red-500/90 dark:text-red-400 font-medium text-xs'>
628	                                      ÎŞ²âËÙÊı¾İ
629	                                    </div>
630	                                  ); // å ä½div
631	                                }
632	                              }
633	                            })()}
634	                          </div>
635	                        </div>
636	                      </div>
637	                    );
638	                  })}
639	                <div className='flex-shrink-0 mt-auto pt-2 border-t border-gray-400 dark:border-gray-700'>
640	                  <button
641	                    onClick={() => {
642	                      if (videoTitle) {
643	                        router.push(
644	                          `/search?q=${encodeURIComponent(videoTitle)}`
645	                        );
646	                      }
647	                    }}
648	                    className='w-full text-center text-xs text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors py-2'
649	                  >
650	                    Ó°Æ¬Æ¥ÅäÓĞÎó£¿µã»÷È¥ËÑË÷
651	                  </button>
652	                </div>
653	              </div>
654	            )}
655	        </div>
656	      )}
657	    </div>
658	  );
659	};
660	
661	export default EpisodeSelector;
662	
